<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="google-adsense-account" content="ca-pub-1460224105367515">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- SEO -->
  <title>合体ナンプレ（重ね合わせ数独）を自由配置｜問題自動生成・矛盾チェック・PNG出力</title>
  <meta name="description" content="複数のナンプレ盤を自由に重ねて合体できる無料Webアプリ。重なりを考慮した自動生成、矛盾チェック、問題・解答の個別PNG保存、JSONエクスポート、ローカル自動保存に対応。">

  <!-- OGP / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="合体ナンプレ（重ね合わせ数独）を自由配置">
  <meta property="og:description" content="重なり対応の自動生成・矛盾チェック・PNG保存に対応した無料Webアプリ。">
  <meta property="og:image" content="/ogp.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- UI（Tailwind） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* キャンバスはJS側でリサイズするため比率だけ指定 */
    #canvas { width: 100%; aspect-ratio: 4 / 3; background:#fff; border:2px solid #e2e8f0; border-radius: .5rem; touch-action: none; }
    #canvas:active { cursor: grabbing; }
    .btn { background:#6366f1; color:#fff; padding:.5rem 1rem; border-radius:.5rem; font-weight:600; transition: .15s; }
    .btn:hover:not(:disabled){ background:#4f46e5; transform: translateY(-1px); }
    .btn:disabled{ background:#cbd5e1; cursor:not-allowed; transform:none; }
    .btn-danger{ background:#ef4444; }
    .btn-secondary{ background:#10b981; }
    .btn-tertiary{ background:#f59e0b; }
    .btn-info{ background:#3b82f6; }
  </style>

  <!-- FAQ構造化データ -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {
        "@type":"Question",
        "name":"いくつまで合体できますか？",
        "acceptedAnswer":{"@type":"Answer","text":"固定上限はなく、端末性能に依存します。目安はPC 12〜20盤／タブレット 9〜12盤／スマホ 4〜9盤です。"}
      },
      {
        "@type":"Question",
        "name":"画像は問題と解答を別々に出力できますか？",
        "acceptedAnswer":{"@type":"Answer","text":"はい。PNGを2ファイル（問題・解答）で保存できます。ファイル名はタイムスタンプ付きです。"}
      },
      {
        "@type":"Question",
        "name":"データはサーバーに送られますか？",
        "acceptedAnswer":{"@type":"Answer","text":"入力はブラウザにローカル保存されます。問題生成時のみ一部APIを使う場合がありますが、作業中の入力値は送信されません。"}
      },
      {
        "@type":"Question",
        "name":"難易度は選べますか？",
        "acceptedAnswer":{"@type":"Answer","text":"生成時に選択できます（Easy / Normal / Hard など）。重なりが多いほど体感難易度は上がります。"}
      }
    ]
  }
  </script>

  <!-- Google AdSense H5 Games Ads (Ad Placement API) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1460224105367515" crossorigin="anonymous"></script>
  <script>
    window.adsbygoogle = window.adsbygoogle || [];
    window.adBreak = window.adConfig = function(o){ (window.adsbygoogle = window.adsbygoogle || []).push(o); };
    try{ adConfig({ sound: 'on' }); }catch(e){}
  </script>
</head>
<body class="bg-slate-100 min-h-screen">
  <!-- ★ 横幅を拡大：max-w-6xl → max-w-screen-2xl に変更 -->
  <div class="max-w-screen-2xl mx-auto p-4">
    <header class="mb-3">
      <h1 class="text-2xl font-bold text-slate-800">合体ナンプレ（重ね合わせ数独）を自由配置できる無料Webアプリ</h1>
      <p class="text-slate-600">複数盤の重なりを考慮して自動生成・矛盾チェック。PNG保存/JSON出力・ローカル自動保存に対応。</p>
    </header>

    <!-- 操作バー -->
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <select id="difficulty" class="border rounded px-2 py-1">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
        <option value="expert">Expert</option>
        <option value="extreme">Extreme</option>
      </select>

      <button id="addSquareButton" class="btn">盤を追加</button>
      <button id="generateProblemButton" class="btn btn-secondary">合体問題を作成</button>
      <button id="checkButton" class="btn btn-tertiary">矛盾チェック</button>
      <button id="solveButton" class="btn btn-info">解答を表示</button>

      <button id="deleteButton" class="btn btn-danger">選択盤を削除</button>
      <button id="clearAllBoardsButton" class="btn btn-danger">すべて削除</button>

      <button id="exportTextButton" class="btn">保存（JSON）</button>
      <button id="exportImageAllButton" class="btn">保存（PNG：問題/解答 別々）</button>

      <!-- ズーム -->
      <div class="flex items-center gap-2 ml-auto">
        <button id="zoomOut" class="btn">−</button>
        <button id="zoomIn" class="btn">＋</button>
        <button id="zoom100" class="btn">100%</button>
        <button id="zoomFit" class="btn">フィット</button>
        <span id="zoomPct" class="text-sm text-gray-600"></span>
      </div>
    </div>

    <!-- 折りたたみ：短いガイド -->
    <details class="mb-3 bg-white border rounded-lg p-3 open:shadow">
      <summary class="cursor-pointer font-semibold text-slate-800">合体ナンプレの遊び方（超かんたんガイド）</summary>
      <div class="mt-2 text-slate-700 leading-relaxed text-sm">
        <ul class="list-disc pl-5 space-y-1">
          <li><strong>盤の追加・移動・削除</strong>：自由配置。縦は<strong>3マス単位</strong>で自動スナップ。</li>
          <li><strong>生成</strong>：配置・重なりを考慮して<strong>一括生成</strong>。</li>
          <li><strong>チェック</strong>：行／列／3×3／<strong>重なり部</strong>の衝突を赤で表示。</li>
          <li><strong>解答表示</strong>：ワンクリックで<strong>ON/OFF</strong>。</li>
          <li><strong>保存</strong>：<strong>PNG（問題・解答は別ファイル）</strong>／<strong>JSON</strong>。ファイル名はタイムスタンプ付き。</li>
          <li><strong>操作</strong>：背景ドラッグで<strong>パン</strong>、ホイールで<strong>ズーム</strong>、<kbd>F</kbd>でフィット。</li>
          <li><strong>上限の目安</strong>：固定上限なし。目安は PC 12〜20盤／タブレット 9〜12盤／スマホ 4〜9盤。</li>
          <li><strong>保存とプライバシー</strong>：作業は<strong>ローカル保存</strong>。入力はサーバー送信しません。</li>
        </ul>
      </div>
    </details>

    <!-- ステータス + キャンバス -->
    <div id="status-container" class="mb-2 text-center text-slate-700 min-h-6">
      <div id="status">盤を追加して「合体問題を作成」を押してください。</div>
    </div>
    <canvas id="canvas"></canvas>

    <!-- 詳しいヘルプ -->
    <section id="help" class="mt-8 bg-white border rounded-lg p-5">
      <h2 class="text-xl font-bold text-slate-800 mb-3">このページの使い方（詳しいヘルプ）</h2>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">できること</h3>
      <ul class="list-disc pl-5 space-y-1 text-slate-700">
        <li><strong>自由レイアウト</strong>：複数盤を好きな位置・重なりで配置</li>
        <li><strong>自動生成</strong>：重なりを加味して一括生成</li>
        <li><strong>矛盾チェック</strong>：行・列・3×3・<strong>重なり</strong>の衝突をハイライト</li>
        <li id="export"><strong>エクスポート</strong>：<strong>PNG</strong>（問題・解答を別ファイル）／<strong>JSON</strong>保存</li>
        <li><strong>自動復元</strong>：作業内容はブラウザにローカル保存</li>
      </ul>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">基本操作</h3>
      <ul class="list-disc pl-5 space-y-1 text-slate-700">
        <li><strong>パン</strong>：背景の左ドラッグ／中 or 右ドラッグ／<kbd>Space</kbd>＋ドラッグ</li>
        <li><strong>ズーム</strong>：ホイール（<kbd>Ctrl/⌘</kbd>＋ホイールで中心ズーム）、<kbd>+</kbd>/<kbd>-</kbd>キー</li>
        <li><strong>全体フィット</strong>：<kbd>F</kbd> キー</li>
        <li><strong>数字入力</strong>：1〜9（与え数字は上書き不可）、<kbd>Backspace/Delete/0</kbd>で消去</li>
        <li><strong>セル移動</strong>：矢印キー、<strong>盤移動</strong>：盤内ドラッグ（縦は3マス単位に吸着）</li>
      </ul>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">盤の重なりルール</h3>
      <p class="text-slate-700 leading-relaxed">
        重なり領域は同一マスとして一貫して扱われます。矛盾する数字があると該当セルが<strong class="text-red-600">赤</strong>で強調表示されます。
      </p>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">画像出力の仕様</h3>
      <ul class="list-disc pl-5 space-y-1 text-slate-700">
        <li><strong>問題画像</strong>：与え数字のみ／白背景・黒グリッド</li>
        <li><strong>解答画像</strong>：全セルの解答を描画</li>
        <li><strong>ファイル名</strong>：タイムスタンプ付き（例：<code>gattai_problem_YYYYMMDD_HHMMSS.png</code>, <code>gattai_solution_YYYYMMDD_HHMMSS.png</code>）</li>
      </ul>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">いくつまで合体できる？（上限の目安）</h3>
      <p class="text-slate-700 leading-relaxed">
        アプリ側の固定上限はありません。盤が増えると描画や重なり判定（盤数の二乗で増加）が重くなります。快適性の目安は
        <strong>PC 12〜20盤／タブレット 9〜12盤／スマホ 4〜9盤</strong>です（端末性能によって異なります）。
      </p>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">保存とプライバシー</h3>
      <p class="text-slate-700 leading-relaxed">
        盤配置・入力はブラウザの<strong>ローカル保存のみ</strong>。問題生成で外部APIを利用する場合がありますが、作業中の入力値は送信されません。
      </p>

      <h3 class="font-semibold text-slate-800 mt-4 mb-2">よくある質問（FAQ）</h3>
      <dl class="text-slate-700 space-y-3">
        <div>
          <dt class="font-semibold">Q. 既定の難易度は？</dt>
          <dd>A. 生成時に選択できます（Easy / Normal / Hard など）。重なりが多いほど体感難易度は上がります。</dd>
        </div>
        <div>
          <dt class="font-semibold">Q. 画像サイズは？</dt>
          <dd>A. 盤配置の外接矩形＋余白で作成し、内部的に<strong>高解像度（スケール2）</strong>で描画します。</dd>
        </div>
        <div>
          <dt class="font-semibold">Q. レイアウトだけ変えて再生成できますか？</dt>
          <dd>A. 可能です。盤を移動してから再度「合体問題を作成」を実行してください。</dd>
        </div>
        <div>
          <dt class="font-semibold">Q. 共有するには？</dt>
          <dd>A. PNG画像の配布が手軽です。編集データの受け渡しにはJSONエクスポートをご利用ください。</dd>
        </div>
      </dl>
    </section>

    <!-- （将来のAdSense配置メモ）
      * CLS回避のため、広告枠は固定サイズのプレースホルダを事前確保してください。
      * おすすめ位置：
        - このヘルプセクションの直前 or 直後
        - FAQの下（本文末尾付近）
      * 主要操作UI（ボタン列・キャンバス）の近くには置かない（誤クリック防止）
    -->
  </div>

  <script src="script.js"></script>

<!-- === High-Res Choice Modal (低解像度/標準/高画質) === -->
<div id="hires-modal-backdrop" style="
  position:fixed; inset:0; background:rgba(0,0,0,.35);
  display:none; align-items:center; justify-content:center; z-index:9999;">
  <div role="dialog" aria-modal="true" style="
    background:#fff; color:#111; width:min(92vw,520px); border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,.25);">
    <div style="padding:16px 20px; border-bottom:1px solid #eee; font-weight:600;">保存品質を選択</div>
    <div style="padding:16px 20px;">
      <p style="margin:0 0 12px 0; line-height:1.6;">
        <strong>広告なし</strong>は<strong>低解像度</strong>になります。標準/高画質は広告視聴後に保存します。
      </p>
      <div style="display:flex; gap:12px; flex-wrap:wrap;">
        <button data-scale="1" class="hr-btn" style="flex:1 1 120px; padding:12px 14px; border-radius:10px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer;">
          低解像度（広告なし）
        </button>
        <button data-scale="2" class="hr-btn" style="flex:1 1 120px; padding:12px 14px; border-radius:10px; border:1px solid #0a7; background:#0a7; color:#fff; cursor:pointer;">
          標準（広告視聴）
        </button>
        <button data-scale="4" class="hr-btn" style="flex:1 1 120px; padding:12px 14px; border-radius:10px; border:1px solid #095; background:#095; color:#fff; cursor:pointer;">
          高画質（広告視聴）
        </button>
      </div>
    </div>
    <div style="padding:12px 20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:8px;">
      <button id="hires-cancel" style="padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer;">キャンセル</button>
    </div>
  </div>
</div>
<style>
  #hires-modal-backdrop .hr-btn:active { transform: translateY(1px); }
</style>

<!-- === Hooks: Rewarded Ad + Quality Selection (PNG save) === -->
<script>
(function(){
  function $(sel){ return document.querySelector(sel); }
  function showChoice(onPick){
    var bd = $('#hires-modal-backdrop');
    if (!bd) return onPick(1);
    bd.style.display = 'flex';
    var done = false;
    function close(){ if(!bd) return; bd.style.display='none'; bd.removeEventListener('click', outside); }
    function outside(e){ if(e.target===bd){ close(); } }
    bd.addEventListener('click', outside);
    bd.querySelectorAll('.hr-btn').forEach(function(btn){
      btn.onclick = function(){
        if (done) return;
        done = true;
        var scale = parseInt(btn.getAttribute('data-scale'),10)||1;
        close();
        onPick(scale);
      };
    });
    var cancel = $('#hires-cancel');
    if (cancel) cancel.onclick = function(){ close(); onPick(1); };
  }

  function attachPngHookById(id){
    var btn = document.getElementById(id);
    if (!btn) return;
    var reentrant = false;
    btn.addEventListener('click', function(ev){
      if (reentrant) return;
      ev.stopImmediatePropagation();
      ev.preventDefault();

      showChoice(function(scale){
        function proceed(withScale){
          window.__EXPORT_SCALE__ = withScale;
          reentrant = true; btn.click(); reentrant = false;
          setTimeout(function(){ window.__EXPORT_SCALE__ = null; }, 3000);
        }
        if (scale === 1 || typeof window.adBreak !== 'function'){
          proceed(1);
          return;
        }
        window.__EXPORT_SCALE__ = scale; // 2 or 4
        window.adBreak({
          type: 'reward',
          name: 'export-hires-' + scale + 'x',
          beforeReward: function(showAd){ try{ showAd && showAd(); }catch(e){} },
          adViewed: function(){ proceed(scale); },
          adDismissed: function(){ proceed(1); },
          beforeAd: function(){ try{ window.setStatus && setStatus('広告を表示中…'); }catch(_){ } },
          afterAd: function(){}
        });
      });
    }, { capture: true });
  }

  attachPngHookById('exportImageAllButton');
  attachPngHookById('exportImageButton');
})();
</script>
</body>
</html>
